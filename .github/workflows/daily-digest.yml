name: Daily Digest

on:
  schedule:
    - cron: '30 4 * * *' # 05:30 CET / 04:30 UTC
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: daily-digest
  cancel-in-progress: false

env:
  NEXT_TELEMETRY_DISABLED: 1
  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
  NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
  SUPABASE_SERVICE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
  SUPABASE_SECRET_KEY: ${{ secrets.SUPABASE_SECRET_KEY }}
  PUBLIC_SITE_URL: ${{ secrets.PUBLIC_SITE_URL }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  MAILCHANNELS_AUTH_TOKEN: ${{ secrets.MAILCHANNELS_AUTH_TOKEN }}
  UNSUBSCRIBE_SECRET: ${{ secrets.UNSUBSCRIBE_SECRET }}
  DISPATCH_TOKEN: ${{ secrets.DISPATCH_TOKEN }}
  ENABLE_TTS: ${{ secrets.ENABLE_TTS }}
  PIPER_VOICE: ${{ secrets.PIPER_VOICE }}
  PIPER_BINARY: ./piper/piper

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Download Piper (optional)
        if: env.ENABLE_TTS == 'true'
        run: |
          mkdir -p piper
          curl -L https://github.com/rhasspy/piper/releases/download/v1.2.0/piper_linux_x86_64.tar.gz | tar xz -C piper --strip-components=1
          chmod +x piper/piper

      - name: Ensure output dir
        run: mkdir -p out

      - name: Generate digest
        run: npx tsx scripts/dailyDigest.ts

      - name: Upload digest artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: latest-digest
          path: out/
          retention-days: 7

      - name: Trigger dispatch worker
        if: success()
        env:
          DISPATCH_URL: ${{ secrets.DISPATCH_URL }}
          DISPATCH_TOKEN: ${{ secrets.DISPATCH_TOKEN }}
        run: |
          if [ -z "$DISPATCH_URL" ]; then
            echo "‚ö†Ô∏è DISPATCH_URL not configured - skipping email dispatch"
            echo "Digest generated successfully but no emails sent"
            exit 0
          fi

          echo "üöÄ Triggering email dispatch to: $DISPATCH_URL"
          curl -X POST "$DISPATCH_URL" \
            -H "Authorization: Bearer $DISPATCH_TOKEN" \
            -H "User-Agent: budbringer-bot" \
            -H "Content-Type: application/json" \
            -d '{}' \
            -w "HTTP Status: %{http_code}\n" \
            -s
